# üöÄ Warp Orchestrator ‚Äî TaskRouter + Router MCP (Auto-Loop, Logs, VSCode-Friendly)

## üß≠ Overview
This project wires a **TaskRouter** profile in Warp to a **Router MCP** service that:
- Accepts routing lines (`SubAgent: instruction`),
- **Auto-loops** with TaskRouter until `DONE`,
- Persists history to **Markdown** and **JSONL** so you can audit runs,
- Plays nicely with **VSCode** (do edits in-editor; let Warp handle orchestration/policy).

You start the workflow with **one human-readable prompt** in TaskRouter chat. TaskRouter **auto-forwards** the first routing line to the Router MCP with `auto_loop:true`, and the system runs to completion with a final `DONE + summary`.

---

## üóÇÔ∏è File Structure
```
warp-orchestrator/
‚îú‚îÄ LICENSE
‚îú‚îÄ README.md
‚îú‚îÄ instructions.md
‚îú‚îÄ router_mcp.py # Router MCP server (with Markdown + JSONL persistence, auto-loop, workflow_id)
‚îú‚îÄ orchestrator.sh # One-command launcher + live tail (macOS/Linux)
‚îú‚îÄ orchestrator.ps1 # One-command launcher + live tail (Windows) [optional]
‚îú‚îÄ warp_config/
   ‚îú‚îÄ warp-agent-config.yaml
   ‚îú‚îÄ warp-config.yaml
‚îú‚îÄ docs/
‚îÇ  ‚îú‚îÄ CHANGELOG.md # Auto-appended final summaries per run
‚îÇ  ‚îú‚îÄ build-summary.md # Step-by-step log + final block
‚îÇ  ‚îú‚îÄ router_log.jsonl # Structured event log
‚îÇ  ‚îî‚îÄ site-spec.md # Source-of-truth spec for your website build
‚îî‚îÄ project/
   ‚îî‚îÄ src/ # Where pages/assets are generated by agents
```

---

## üõ†Ô∏è Installation
1) **Clone / copy** this folder somewhere local.  
2) **Install Python deps**:
```bash
pip install fastapi uvicorn pydantic
```
3) **(Optional) VSCode**: open `project/` for code editing; keep Warp for orchestration.

---

## ‚öôÔ∏è Settings (Environment)
Set these (or rely on defaults):
```bash
export ROUTER_LOG_DIR=/absolute/path/to/warp-orchestrator/docs   # default: ./docs next to router_mcp.py
export ROUTER_MAX_STEPS=10                                       # safety cap for auto-loop
# export ROUTER_PORT=8085                                         # if you choose to expose a custom port (optional)
```

---

## üß© Warp Settings (UI, Option B)
**Add MCP server**  
- Settings ‚Üí Agents/MCP Servers ‚Üí **Add**
  - Name: `router-mcp`
  - Type: `HTTP`
  - URL: `http://localhost:8085/route`

**Create profiles** (names must match):
- `TaskRouter` (orchestrator, **allowed_mcp_servers: [router-mcp]**)
- `FileCreator`, `FrontendDeveloper`, `BackendDeveloper`, `TestRunner`, `GitWorkflow`, `UIDesigner`, `UXResearcher`, `SprintPrioritizer`, `RapidPrototyper`  
Give each its system prompt and **restrict permissions** (e.g., GitWorkflow = git-only MCP, no shell; FileCreator = file write, no shell).

**TaskRouter system prompt (core excerpt)**  
> The user will give a high-level brief. You MUST convert it into the first routing line and IMMEDIATELY call `router-mcp` with:
> ```json
> {
>   "task": "<SubAgentName>: <refined instruction>",
>   "auto_loop": true,
>   "workflow_id": "<use user's id if provided, else generate kebab-case>",
>   "from_taskrouter": true
> }
> ```
> After calling the tool, reply with a short acknowledgment only. During the run, be silent. On completion, output:
> ```
> DONE
> <1‚Äì3 sentence final summary>
> ```

---

## üîÅ Auto-Loop Toggle (How it Works)
- **Manual**: send `"auto_loop": false` in Router requests (single-step).  
- **Auto**: send `"auto_loop": true` (Router loops with TaskRouter to `DONE`).  
- **Enforcement for kickoff**: the Router honors `from_taskrouter:true` on the **first** TaskRouter call and forces `auto_loop=true` (so a single human prompt launches a full run).

---

## ‚ñ∂Ô∏è Example Workflow

### 0) Start Router MCP
Use the launcher (recommended):
```bash
./orchestrator.sh
# Tails /docs/build-summary.md and /docs/router_log.jsonl as steps run
```
(Windows: `.\orchestrator.ps1`)

### 1) üßë‚Äçüíª Human prompt (TaskRouter chat)
Paste this (one message):
```
workflow_id: site-scaffold-001

Use /docs/site-spec.md as the source of truth. Execute the full build:
- Scaffold structure and files as specified
- Implement Home (hero, #disciplines, #contact, skip link, landmarks)
- Implement all three service pages with back-to-/#disciplines CTA
- Implement About and minimal JS
- Commit safely

Respond only with routing lines internally via router-mcp (auto_loop:true).
When complete, output:
DONE
<1‚Äì3 sentence final summary>
```

**TaskRouter visible reply**:  
`Kicked off workflow (id: site-scaffold-001). I‚Äôll summarize when done.`

### 2) üîß Behind the scenes
- TaskRouter calls `router-mcp` with:
```json
{
  "task": "FileCreator: Create folders /project/src/pages/services, /project/src/assets/styles, /project/src/assets/scripts and create files /project/src/pages/index.html, /project/src/pages/about.html, /project/src/pages/services/frontend.html, /project/src/pages/services/backend.html, /project/src/pages/services/robotics.html, /project/src/assets/styles/main.css, /project/src/assets/scripts/main.js",
  "auto_loop": true,
  "workflow_id": "site-scaffold-001",
  "from_taskrouter": true
}
```
- Router ‚Üî TaskRouter iterate through FrontendDeveloper, etc., until GitWorkflow commits and TaskRouter returns `DONE`.

### 3) üóÉÔ∏è Logs & Final Output
- `/docs/build-summary.md`: human-readable timeline (steps + final block)  
- `/docs/router_log.jsonl`: structured event log  
- `/docs/CHANGELOG.md`: per-run completion entry  
- TaskRouter chat prints:
```
DONE
Scaffolded the consultancy site; implemented home, three service pages, about, base CSS/JS; committed initial version.
```

---

## üîê Security & Permissions
- **Least privilege** per profile:
  - `GitWorkflow`: git MCP only; no shell.
  - `FileCreator`/`FrontendDeveloper`/`BackendDeveloper`: file write OK; **no shell**.
  - `TestRunner`: tests-only MCP; **no edits**.
- **Stop conditions**:
  - TaskRouter emits `DONE`.
  - Router enforces `ROUTER_MAX_STEPS` as a hard cap.
- **Auditability**: Steps + final summaries persisted to disk.
- **Isolation**: Keep work under `project/`; specs in `/docs/site-spec.md`.

---

## üí° Tips & Extensions
- **Spec-driven builds**: Put project rules in `/docs/site-spec.md` and reference it in prompts.
- **VSCode for edits**: Use VSCode + Claude extension for inline diffs; Warp for orchestration.
- **Design previews**: Add `superdesign-mcp` for `UIDesigner`/`UXResearcher`.
- **Kickoff via HIGHLEVEL**: Extend Router to accept `HIGHLEVEL: ‚Ä¶` so you don‚Äôt craft the first routing line.
- **CI hooks**: Post `CHANGELOG.md` summaries to PRs; visualize `router_log.jsonl` with a small dashboard.

---

## üß∞ Troubleshooting
- **Router not reachable** ‚Üí `curl http://localhost:8085/health`; check port/process/firewall.  
- **No logs** ‚Üí ensure `ROUTER_LOG_DIR` exists/writable; launcher creates files.  
- **Profiles can‚Äôt call router** ‚Üí add `router-mcp` to TaskRouter‚Äôs `allowed_mcp_servers`.  
- **Workflow stalls** ‚Üí inspect `/docs/router_log.jsonl` for `invalid format` / `unknown_agent`.  
- **Infinite loop risk** ‚Üí keep `ROUTER_MAX_STEPS` (default 10); confirm TaskRouter prompt includes `DONE`.

---

## ‚úÖ Summary
- **One prompt** to TaskRouter launches a **fully automated** build with **auto-loop** to `DONE`.  
- Everything is **logged** (Markdown + JSONL) and **auditable**.  
- You keep **policy control** via profile permissions and comfortably iterate code in **VSCode** while Warp handles orchestration.

Happy building! üõ†Ô∏è‚ú®

‚ö†Ô∏è This project is not open source. Use is prohibited without explicit permission. Contact me for licensing options.

