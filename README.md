# üöÄ WARP Multi-Step Prompt Orchestration: Agent + MCP + Task

## üß≠ Overview
This repo wires a **TaskRouter** profile in Warp to a **Router MCP** (`router_mcp.py`) that:
- Accepts routing lines (`SubAgent: instruction`)
- **Auto-loops** with TaskRouter until `DONE`
- Persists history to **Markdown** and **JSONL** for audit
- Plays nicely with **VSCode** (edit code in-editor; let Warp handle orchestration/policy)

You start the workflow with **one human-readable prompt** in TaskRouter chat. TaskRouter auto-forwards the first routing line to Router MCP with `auto_loop:true`, and the system runs to completion with a final `DONE + summary`.

---

## üóÇÔ∏è File Structure
```
Warp_AI_Agentic_Orchestrator/
‚îú‚îÄ‚îÄ docs/

‚îú‚îÄ‚îÄ project/                      # Where pages/assets are generated by agents
‚îÇ   ‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ build-summary.md       # Step-by-step log + final block results
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CHANGELOG.md           # Auto-appended final summaries per build
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ router_log.jsonl       # Structured event log
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ site-spec.md           # Source-of-truth spec for your web orchestration
‚îú‚îÄ‚îÄ warp_config/
‚îÇ   ‚îú‚îÄ‚îÄ warp_rules/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ taskrouter_orchestrator.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ warp-agent-config.yaml
‚îÇ   ‚îî‚îÄ‚îÄ warp-mcp-config.yaml
‚îú‚îÄ‚îÄ .env                       # Create this file and keep it local, as it is in .gitignore
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ LICENSE
‚îú‚îÄ‚îÄ manual_and_auto-run_modes.md
‚îú‚îÄ‚îÄ mcp_gui_manager.py
‚îú‚îÄ‚îÄ mcp_router_shim.py
‚îú‚îÄ‚îÄ orchestrator.ps1           # One-command launcher + live tail (Windows)
‚îú‚îÄ‚îÄ orchestrator.sh            # One-command launcher + live tail (macOS/Linux)
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ router_mcp.py              # Router MCP server (Markdown + JSONL logs, auto-loop, workflow_id)
```

---

## ‚úÖ Prerequisites
- **Python 3.10+**
- **Warp** (latest)
- **Node 18+** (for stdio MCP servers via `npx`)
- (Optional) **VSCode** + Claude extension
- (Optional) **GITHUB_TOKEN** (fine-grained PAT) if you‚Äôll use GitHub MCP (PRs/issues)

---

## üõ†Ô∏è Install & Run Router MCP
### 1) Install Python deps
```bash
pip install fastapi uvicorn pydantic
```
### 2) (Optional) Set environment
```bash
export ROUTER_LOG_DIR="$(pwd)/docs"     # default: ./docs next to router_mcp.py
export ROUTER_MAX_STEPS=17              # safety cap for auto-loop
export ROUTER_ENFORCE_RULE_ACK=true     # require 'rules loaded (...)' ack
export ROUTER_PORT=8085                 # default 8085
```
### 3) Start the Router MCP (either script or python)
```bash
# For macos/linux: 
./orchestrator.sh

# For Windows Powershell 7: 
pwsh -NoProfile -ExecutionPolicy Bypass -File .\orchestrator.ps1

# View live logs in another terminal(s):
- tails /docs/build-summary.md and /docs/router_log.jsonl as steps run
```
---

## üß© Warp UI Setup (Profiles, MCP Servers, Rules)

> Goal: Warp remains the **caller** of the LLM; Router MCP orchestrates & logs.

### 1) üñ•Ô∏è MCP Servers
- Open **Warp ‚Üí Settings ‚Üí AI ‚Üí MCP Servers**
- Use the **JSON** input method and paste the **one-shot JSON** from this repo‚Äôs `warp_config/warp-mcp-config.yaml` (**do not retype**; just copy/paste it into Warp).  
  - That JSON registers:
    - `file-mcp` (Official Filesystem, stdio)
    - `git-mcp` (cyanheads local git, stdio)
    - `github-mcp` (GitHub official server, stdio)
    - `test-mcp` (privsim test runner, stdio)
    - `superdesign-mcp` (SuperDesign packaged MCP, stdio)
    - `router-mcp` (HTTP ‚Üí `http://localhost:8085/route`)
  - **Then** keep a copy of the same JSON in this repo at `warp_config/warp-mcp-config.yaml` (source of truth for teammates).

> Replace all placeholder absolute paths with your real path to `Warp_AI_Agentic_Orchestrator/project`, and set a real `GITHUB_TOKEN` in your shell.

> `IMPORTANT`:  Before starting update the absolute paths in all the MCP servers.
> > **So the agents can only edit files inside that folder and never anything outside if it.**

### 2) üì¶ IMPORTANT: Local MCP Servers

- `Important`: Some open-sourse repos such as test-mcp will have to be `cloned and run locally`, instead of using `npx`.
  - Keep them in a `single shared folder outside your project` so you don‚Äôt re-clone per repo.
  - For each MCP server, sometimes specific file paths will have to be referenced within the respective Warp MCP server config JSON 
> Having dedicated MCP folder prevents having to change the stored path(s) in that MCP server JSON config, when changing projects.
> > Note: The `working directory` value will still have to be changed when switching projects.

### 3) üñºÔ∏è Profiles (Agents)
- Open **Warp ‚Üí Settings ‚Üí AI ‚Üí Profiles + Add**
- Create profiles named exactly:
  - `TaskRouter`, `FileCreator`, `FrontendDeveloper`, `BackendDeveloper`, `TestRunner`, `GitWorkflow`, `UIDesigner`, `UXResearcher`, `SprintPrioritizer`, `RapidPrototyper`
- Create profiles with these **Allowed MCP Servers** and **Permissions**:
  - **TaskRouter** ‚Üí Allowed: `router-mcp`; *no* file write; *no* execute commands.
  - **FileCreator** ‚Üí Allowed: `file-mcp`; file read/write **on**, execute commands **off**.
  - **FrontendDeveloper** ‚Üí Allowed: `file-mcp`; file read/write **on**, execute **off**.
  - **BackendDeveloper** ‚Üí Allowed: `file-mcp`; file read/write **on**, execute **off**.
  - **GitWorkflow** ‚Üí Allowed: `git-mcp`; file write **off**, execute **off**.
  - **TestRunner** ‚Üí Allowed: `test-mcp`; file write **off**, execute **off**.
  - **UIDesigner** ‚Üí Allowed: `superdesign-mcp` (+ `file-mcp` if you want to save artifacts); file read/write **on**.
  - **UXResearcher** ‚Üí Allowed: `superdesign-mcp` (+ `file-mcp` if you want to save artifacts); file read/write **on**.
  - **SprintPrioritizer** ‚Üí Allowed: `file-mcp`; file read/write **on**.
  - **RapidPrototyper** ‚Üí Allowed: `file-mcp`; file read/write **on**.
- For each profile:
  - **Allowed MCP Servers**: match the spec in `warp_config/warp-agent-config.yaml` (copy from that file into the UI)
  - **Permissions**: set minimal privileges (e.g., GitWorkflow: no file writes; FileCreator: file writes allowed; no command execution for all)
  - **Model**: Sonnet (latest) for TaskRouter/FE/BE/FileCreator; Haiku for GitWorkflow/TestRunner

> Use `warp_config/warp-agent-config.yaml` as the authoritative checklist (drag/drop to view; copy values into Warp UI).

### 4) ‚öñÔ∏è Rules (acts like system prompts)
- Open **Warp Drive ‚Üí Rules**
- Create one Rule per profile with the exact titles:
  - `TaskRouter - TaskRouter Policy`
  - `FileCreator - FileCreator Policy`
  - `FrontendDeveloper - FrontendDeveloper Policy`
  - `BackendDeveloper - BackendDeveloper Policy`
  - `GitWorkflow - GitWorkflow Policy`
  - `TestRunner - TestRunner Policy`
  - `UIDesigner - UIDesigner Policy`
  - `UXResearcher - UXResearcher Policy`
  - `SprintPrioritizer - SprintPrioritizer Policy`
  - `RapidPrototyper - RapidPrototyper Policy`
- Paste the text from `warp_config/warp_rules/*.md` for each role.

**Good to know:**  
`router_mcp.py` auto-injects the correct Rule each step and requires the agent to acknowledge with:
```
rules loaded (agent=<Role> | rule=<Rule Title>)
```
- No extra user action needed in chat; the Router guarantees each profile loads its Rule before executing.

### 5) üß† Sanity Check
- Start the Router MCP:
  ```bash
  ./orchestrator.sh
  ```
- In Warp, open the **TaskRouter** chat and paste the kickoff prompt from the Example Workflow (below).
- Confirm logs appear in `/docs/build-summary.md` and `/docs/router_log.jsonl`.

---

## üîÅ Auto-Loop Toggle (How it Works)

### 1) Full Auto (silent)
- **Settings**:
    ```
    ROUTER_FORCE_AUTORUN=true
    ROUTER_STEPWISE_ECHO=false
    (ROUTER_ECHO_FINAL can be true/false)
    ```
  - **Behavior**:
    - Router loops internally to DONE in a single tool call.
    - TaskRouter is quiet until the end.
    - If `ROUTER_ECHO_FINAL=true`, step lines appear only in the final result/logs (not in chat).

### 2) Auto-run with stepwise echo (semi-auto, visible)
- **Settings**:
    ```
    ROUTER_FORCE_AUTORUN=true
    ROUTER_STEPWISE_ECHO=true
    ROUTER_ECHO_FINAL=true   ‚Üê recommended for visible lines
    ```   
    - **Behavior**:
      - Router returns after each step with done:false and message:"Agent: ‚Ä¶".
      - TaskRouter immediately calls the router again (no human confirmation).
      - You see each routing line in chat as it happens.

### 3) Manual
- **Settings**:
    ```
    ROUTER_FORCE_AUTORUN=false   (STEPWISE_ECHO doesn‚Äôt change that it‚Äôs manual)
    (ROUTER_ECHO_FINAL optional)
    ```
  - **Behavior**:
    - Router returns after each step and waits.
    - TaskRouter shows the line and pauses; you type ‚Äúcontinue/next‚Äù (or re-invoke) to proceed.

### 4) Quick Reference:
>`ROUTER_ECHO_FINAL` only controls whether **step lines are emitted/returned; it does NOT change auto vs manual**.

>> For ‚Äú**auto + visible steps**,‚Äù use: `FORCE_AUTORUN=true`, `STEPWISE_ECHO=true`, `ECHO_INTERMEDIATE=true`.

>> For ‚Äú**fully silent auto**,‚Äù use: `FORCE_AUTORUN=true`, `STEPWISE_ECHO=false` `(ECHO_INTERMEDIATE optional)`.

---

## ‚ñ∂Ô∏è Example Workflow

### 1) Launch Router MCP
```bash
./orchestrator.sh (macos/Linux)
./orchestrator.ps1 (Windows)
# Tails /docs/build-summary.md and /docs/router_log.jsonl
```

### 2) Use Warp to create a WARP.md based on your custom site-spec.md file
#### 2.1) Use prompt to create a site-map.md file _(not whilst runner the router-mcp)_:
  - To define, how your project should be built:
```text
You are a meticulous repo cartographer. Create a comprehensive, human-readable site map for THIS Python project and save it to: docs/site-map.md (create the folder if missing). Do not modify code.

GOAL
- Produce a single Markdown file that helps a new engineer understand structure, entry points, frameworks, APIs/CLIs, data models, tests, and how to run the project.

SCOPE
- Works for ANY Python project type: web (FastAPI/Django/Flask), libraries/packages, CLIs (click/argparse/typer), notebooks, microservices/monorepos.
- Infer frameworks/tooling from repo signals (e.g., pyproject.toml, requirements*.txt, Pipfile*, poetry.lock, setup.cfg, manage.py, app.py, asgi.py/wsgi.py, Django settings/urls, FastAPI imports, Flask app factories, click/argparse usage).
- Ignore noise: .git, .venv, __pycache__, build/, dist/, .mypy_cache/, .pytest_cache/, node_modules/, .DS_Store.

OUTPUT (Markdown)
# Project Site Map

## Overview
- **Project name:** <infer from pyproject.toml or folder>
- **Python:** <version if pinned; else ‚Äúunspecified‚Äù>
- **Primary stack:** <infer (e.g., FastAPI + Jinja2 + Tailwind + vanilla JS + optional HTMX) or ‚Äúlibrary/CLI‚Äù>
- **How to run (quick start):**
  - Dev install: <pip/uv/poetry/pipenv command>
  - Run server / CLI: <commands>

## Directory Tree (high-level)
- Show a collapsed tree (depth ‚â§ 2). For large dirs, show top files + ‚Äú(+N more‚Ä¶)‚Äù.
- Annotate each top node briefly (what lives there).
- Prefer these roots when present: api/, app/, src/, templates/, static/, assets/, tests/, scripts/, docs/, migrations/, data/.

## Entry Points
- Web: list Uvicorn/Gunicorn/Django run commands, main app objects (e.g., app = FastAPI()) and module paths.
- CLI: list console entry_points or python -m invocations.
- Notebooks: list key .ipynb with 1-line purpose.

## Routes / Commands
- FastAPI/Flask: list detected routes (method + path + handler), group by router/blueprint.
- Django: list top-level url patterns (namespace ‚Üí path sample).
- CLI: list top-level commands/subcommands (click/argparse/typer), with 1-line purpose.

## Templates / Static
- Templates: location (e.g., templates/‚Ä¶); base layout(s).
- Static: css/js/img locations; note Tailwind output (e.g., static/css/main.css) and source (assets/styles/input.css).
- JS behavior: note modules providing form validation, smooth scroll, etc.
- Optional HTMX: note fragments/endpoints used for swaps.

## Data Models & Storage
- List ORM/dataclasses/Pydantic models and where they live; summarize key entities.
- Note database/migrations layer if present (SQLAlchemy/Django ORM/etc.).

## Tests
- Test framework (pytest/unittest) and how to run tests; test folders; fixtures.

## Configuration
- Config files (pyproject.toml, settings.py, .env.example, .flake8/ruff, mypy.ini, pytest.ini) + what they control.

## Dependencies
- Manager (uv/poetry/pipenv/pip) and the key runtime deps (web framework, ORM, task queues, etc.).

## Operations
- Common scripts/Make targets (format, lint, test, build, run).
- Env vars needed for a basic run (name only, not secrets).

## Glossary (optional)
- Short definitions for internal terms or service names.

ACCEPTANCE
- File saved at docs/site-map.md.
- All paths clickable (relative links) where useful.
- No giant dumps; summarize large folders. Clear, concise, and current.

```

#### 2.2) Use prompt to create a WARP.md file _(not whilst runner the router-mcp)_:
```text
You are writing a concise Warp Project Rules file for THIS repository. Create WARP.md at the project root. Keep it short, high-signal, and reference docs/site-map.md for details. Do not duplicate the whole spec-just rules/guardrails that Warp should auto-apply to agents.

OUTPUT (Markdown)
# Project Rules (Warp)

**North Star:** Follow the repository‚Äôs structure and conventions; favor least-privilege edits and spec alignment over speculation.  
**Source of truth:** See `./docs/site-map.md` for architecture, directories, entry points, routes/commands, and run instructions.

## Scope & Boundaries
- Respect the existing stack inferred from the project (e.g., FastAPI/Django/Flask or library/CLI). Do NOT introduce a new framework unless explicitly requested.
- Keep code changes within the proper areas (see ‚ÄúDirectory Tree‚Äù in `docs/site-map.md`).
- For web apps:
  - Templates live under `templates/`; static under `static/`; do not bypass the configured app factory/asgi module.
  - If Tailwind is used: build once to `static/css/main.css`; avoid ad-hoc style drift.
  - JS: keep to the current paradigm (vanilla or framework chosen by the project). HTMX only if already in use or explicitly requested.

## Musts (Non-Negotiable)
- Accessibility basics for any HTML output (landmarks, skip link to #main, labels/focus, AA contrast) when editing UI templates.
- Preserve existing public APIs/CLIs and their contracts unless the task is to change them.
- Add/update tests where behavior changes (follow existing test framework).
- Keep configs and secrets out of code; reference env vars and `.env.example` patterns.

## Style & Structure
- Follow import/module structure already present (app factory, routers/blueprints, settings modules).
- Keep shared layout (base templates, common components) consistent and DRY.
- Use project formatters/linters (e.g., ruff/black/isort) and type hints if present.

## Prohibitions
- Do not create speculative files or folders outside the structure defined in `docs/site-map.md`.
- Do not switch dependency managers or framework families without explicit instruction.
- Avoid heavy client libraries unless justified by the task.

## Tooling Notes
- When creating or editing files, keep them under the correct directories listed in `docs/site-map.md`.
- When adding routes/commands, register them via the project‚Äôs established pattern (routers/urls, app factories, entry_points).

## Completion
- On task completion, summarize changes (files touched, routes/commands added, tests updated) in clear prose.

Notes:
- If a rule conflicts with `docs/site-map.md`, prefer `docs/site-map.md` and call it out in the summary.

```

### 3) Kickoff (TaskRouter chat)
Paste this single message:
```
workflow_id: site-scaffold-001
Use /docs/site-spec.md. Stack: FastAPI + Jinja2; Tailwind ‚Üí project/static/css/main.css; vanilla JS; HTMX optional.
Respond only with routing lines (router-mcp).
When complete, output:
DONE
<1‚Äì3 sentence final summary>
```

**Expected visible reply (TaskRouter):**  
`Kicked off workflow (id: site-scaffold-001). I‚Äôll summarize when done.`

### 3) Behind the scenes
- Router transforms each routing line into a guarded instruction:
  - Adds **SubAgent prefix**
  - Applies the correct **Rule title**
  - Requires the **rules-loaded** acknowledgment
- Router loops with TaskRouter until `DONE` (or max steps cap).

### 4) Logs & Final Output
- `/docs/build-summary.md` - human timeline (steps + final block)  
- `/docs/router_log.jsonl` - structured event log  
- `/docs/CHANGELOG.md` - one entry per completed run  
- TaskRouter chat ends with:
```
DONE
<1‚Äì3 sentence final summary>
```

---

## üîê Security & Permissions
- **Least privilege** per profile:
  - `GitWorkflow`: git MCP only; no shell
  - `FileCreator`/`FrontendDeveloper`/`BackendDeveloper`: file writes OK; no shell
  - `TestRunner`: test MCP only; no edits
- **Stop conditions**:
  - TaskRouter emits `DONE`
  - Router enforces `ROUTER_MAX_STEPS`
- **Auditability**: All steps + final summaries persisted to `/docs/`
- **Isolation**: Keep code under `/project/`; specs in `/docs/site-spec.md`

---

## üß∞ Troubleshooting
- **Router not reachable** ‚Üí `curl http://localhost:8085/health` (check port/process/firewall)
- **No logs** ‚Üí ensure `/docs/` is writable; launcher scripts create files if missing
- **Profiles can‚Äôt call Router** ‚Üí ensure `router-mcp` is allowed for **TaskRouter**
- **Workflow stalls** ‚Üí open `/docs/router_log.jsonl` and look for `invalid_format` or `unknown_agent`
- **Ack issues** ‚Üí `ROUTER_ENFORCE_RULE_ACK=true` requires the exact first line:
  ```
  rules loaded (agent=<Role> | rule=<Rule Title>)
  ```

---

## üì¶ What goes where (recap)
- **Warp UI**  
  - *MCP Servers*: paste the **one-shot JSON** from `warp_config/warp-mcp-config.yaml`  
  - *Profiles*: mirror from `warp_config/warp-agent-config.yaml` (names, model, permissions, allowed servers)  
  - *Rules*: paste from `warp_config/warp_rules/*.md` (one Rule per profile)
- **Repo**  
  - `warp_config/warp-mcp-config.yaml` - the JSON you pasted into Warp (kept here for team reference)  
  - `warp_config/warp-agent-config.yaml` - authoritative profile spec (names, perms, allowed servers)  
  - `warp_config/warp_rules/*.md` - Rule texts (role ‚Äúsystem prompts‚Äù)  
  - `router_mcp.py` - orchestrator with auto-loop + logs  
  - `docs/*` - logs + spec  
  - `project/src/*` - generated code
> Request/Execution Pipeline (arrow notation):
>> **Warp tool call ‚Üí stdio shim (mcp_router_shim.py) ‚Üí FastAPI (router_mcp.py) ‚Üí stdio shim ToolResult ‚Üí Warp ‚Üí TaskRouter**

---

## ‚úÖ Summary
- Add GitHub API key and add to MCP server ‚Üí ‚úÖ Better: export **`GITHUB_TOKEN`** in your shell; MCP inherits it
- Add MCP servers into Warp config ‚Üí ‚úÖ Paste JSON from `warp_config/warp-mcp-config.yaml` (fix absolute paths)
- Add agents to Warp config ‚Üí ‚úÖ Create profiles in Warp UI, mirror `warp-agent-config.yaml`, then add **Rules**
- Run orchestrator.ps1 ‚Üí ‚úÖ Start Router **before** first prompt
- Run first prompt ‚Üí ‚úÖ Paste into **TaskRouter** chat (auto-loop to `DONE`)
- Notes:
  - **Manual** vs **auto-run** modes:
    - [docs/manual_and_auto-run_modes.md](manual_and_auto-run_modes.md)


