# üöÄ Warp AI Agentic Orchestrator ‚Äî TaskRouter + Router MCP (Auto-Loop, Logs, VSCode-Friendly)

## üß≠ Overview
This repo wires a **TaskRouter** profile in Warp to a **Router MCP** (`router_mcp.py`) that:
- Accepts routing lines (`SubAgent: instruction`)
- **Auto-loops** with TaskRouter until `DONE`
- Persists history to **Markdown** and **JSONL** for audit
- Plays nicely with **VSCode** (edit code in-editor; let Warp handle orchestration/policy)

You start the workflow with **one human-readable prompt** in TaskRouter chat. TaskRouter auto-forwards the first routing line to Router MCP with `auto_loop:true`, and the system runs to completion with a final `DONE + summary`.

---

## üóÇÔ∏è File Structure
```
Warp_AI_Agentic_Orchestrator/
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ CHANGELOG.md           # Auto-appended final summaries per build
‚îÇ   ‚îú‚îÄ‚îÄ build-summary.md       # Step-by-step log + final block results
‚îÇ   ‚îú‚îÄ‚îÄ router_log.jsonl       # Structured event log
‚îÇ   ‚îî‚îÄ‚îÄ site-spec.md           # Source-of-truth spec for your web orchestration
‚îú‚îÄ‚îÄ project/
‚îÇ   ‚îî‚îÄ‚îÄ src/                   # Where pages/assets are generated by agents
‚îú‚îÄ‚îÄ warp_config/
‚îÇ   ‚îú‚îÄ‚îÄ prompts/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ backend_developer.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ file_creator.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ frontend_developer.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ git_workflow.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rapid_prototyper.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sprint_prioritizer.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_runner.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ui_designer.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ux_researcher.md
‚îÇ   ‚îú‚îÄ‚îÄ warp-agent-config.yaml
‚îÇ   ‚îî‚îÄ‚îÄ warp-config.yaml
‚îú‚îÄ‚îÄ instructions.md
‚îú‚îÄ‚îÄ LICENSE
‚îú‚îÄ‚îÄ orchestrator.ps1           # One-command launcher + live tail (Windows)
‚îú‚îÄ‚îÄ orchestrator.sh            # One-command launcher + live tail (macOS/Linux)
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ router_mcp.py              # Router MCP server (Markdown + JSONL logs, auto-loop, workflow_id)
```

---

## ‚úÖ Prerequisites
- **Python 3.10+**
- **Warp** (latest)
- **Node 18+** (for stdio MCP servers via `npx`)
- (Optional) **VSCode** + Claude extension
- (Optional) **GITHUB_TOKEN** (fine-grained PAT) if you‚Äôll use GitHub MCP (PRs/issues)

---

## üõ†Ô∏è Install & Run Router MCP
```bash
# 1) Install Python deps
pip install fastapi uvicorn pydantic

# 2) (Optional) Set environment
export ROUTER_LOG_DIR="$(pwd)/docs"     # default: ./docs next to router_mcp.py
export ROUTER_MAX_STEPS=10              # safety cap for auto-loop
export ROUTER_ENFORCE_RULE_ACK=true     # require 'rules loaded (...)' ack
export ROUTER_PORT=8085                 # default 8085

# 3) Start the Router MCP (either script or python)
./orchestrator.sh
# - tails /docs/build-summary.md and /docs/router_log.jsonl as steps run
# Windows: .\orchestrator.ps1
```

---

## üß© Warp UI Setup (Profiles, MCP Servers, Rules)

> Goal: Warp remains the **caller** of the LLM; Router MCP orchestrates & logs.

### 1) MCP Servers
- Open **Warp ‚Üí Settings ‚Üí AI ‚Üí MCP Servers**
- Use the **JSON** input method and paste the **one-shot JSON** from this repo‚Äôs `warp_config/warp-config.yaml` (**do not retype**; just copy/paste it into Warp).  
  - That JSON registers:
    - `file-mcp` (Official Filesystem, stdio)
    - `git-mcp` (cyanheads local git, stdio)
    - `github-mcp` (GitHub official server, stdio)
    - `test-mcp` (privsim test runner, stdio)
    - `superdesign-mcp` (SuperDesign packaged MCP, stdio)
    - `router-mcp` (HTTP ‚Üí `http://localhost:8085/route`)
  - **Then** keep a copy of the same JSON in this repo at `warp_config/warp-config.yaml` (source of truth for teammates).

> Replace all placeholder absolute paths with your real path to `Warp_AI_Agentic_Orchestrator/project`, and set a real `GITHUB_TOKEN` in your shell.

> `IMPORTANT`:  Before starting update the absolute paths in all the MCP servers.
> > **So the agents can only edit files inside that folder and never anything outside if it.**

### 2) Profiles (Agents)
- Open **Warp ‚Üí Settings ‚Üí AI ‚Üí Profiles + Add**
- Create profiles named exactly:
  - `TaskRouter`, `FileCreator`, `FrontendDeveloper`, `BackendDeveloper`, `TestRunner`, `GitWorkflow`, `UIDesigner`, `UXResearcher`, `SprintPrioritizer`, `RapidPrototyper`
- Create profiles with these **Allowed MCP Servers** and **Permissions**:
  - **TaskRouter** ‚Üí Allowed: `router-mcp`; *no* file write; *no* execute commands.
  - **FileCreator** ‚Üí Allowed: `file-mcp`; file read/write **on**, execute commands **off**.
  - **FrontendDeveloper** ‚Üí Allowed: `file-mcp`; file read/write **on**, execute **off**.
  - **BackendDeveloper** ‚Üí Allowed: `file-mcp`; file read/write **on**, execute **off**.
  - **GitWorkflow** ‚Üí Allowed: `git-mcp`; file write **off**, execute **off**.
  - **TestRunner** ‚Üí Allowed: `test-mcp`; file write **off**, execute **off**.
  - **UIDesigner** ‚Üí Allowed: `superdesign-mcp` (+ `file-mcp` if you want to save artifacts); file read/write **on**.
  - **UXResearcher** ‚Üí Allowed: `superdesign-mcp` (+ `file-mcp` if you want to save artifacts); file read/write **on**.
  - **SprintPrioritizer** ‚Üí Allowed: `file-mcp`; file read/write **on**.
  - **RapidPrototyper** ‚Üí Allowed: `file-mcp`; file read/write **on**.
- For each profile:
  - **Allowed MCP Servers**: match the spec in `warp_config/warp-agent-config.yaml` (copy from that file into the UI)
  - **Permissions**: set minimal privileges (e.g., GitWorkflow: no file writes; FileCreator: file writes allowed; no command execution for all)
  - **Model**: Sonnet (latest) for TaskRouter/FE/BE/FileCreator; Haiku for GitWorkflow/TestRunner

> Use `warp_config/warp-agent-config.yaml` as the authoritative checklist (drag/drop to view; copy values into Warp UI).

### 3) Rules (acts like system prompts)
- Open **Warp Drive ‚Üí Rules**
- Create one Rule per profile with the exact titles:
  - `TaskRouter ‚Äî Orchestrator Policy`
  - `FileCreator ‚Äî File Ops Policy`
  - `FrontendDeveloper ‚Äî UI Policy`
  - `BackendDeveloper ‚Äî API Policy`
  - `GitWorkflow ‚Äî Safe Git Policy`
  - `TestRunner ‚Äî Testing Policy`
  - `UIDesigner ‚Äî Design Artifacts Policy`
  - `UXResearcher ‚Äî Research Artifacts Policy`
  - `SprintPrioritizer ‚Äî Planning Policy`
  - `RapidPrototyper ‚Äî Prototype Policy`
- Paste the text from `warp_config/prompts/*.md` for each role.

**Good to know:**  
`router_mcp.py` auto-injects the correct Rule each step and requires the agent to acknowledge with:
```
rules loaded (agent=<Role> | rule=<Rule Title>)
```
- No extra user action needed in chat; the Router guarantees each profile loads its Rule before executing.

### 5) Sanity Check
- Start the Router MCP:
  ```bash
  ./orchestrator.sh
  ```
- In Warp, open the **TaskRouter** chat and paste the kickoff prompt from the Example Workflow (below).
- Confirm logs appear in `/docs/build-summary.md` and `/docs/router_log.jsonl`.

---

## üîÅ Auto-Loop Toggle (How it Works)
- **Manual**: send `"auto_loop": false` in Router requests (single-step).  
- **Auto**: send `"auto_loop": true` (Router loops with TaskRouter to `DONE`).  
- **Enforcement for kickoff**: the Router honors `from_taskrouter:true` on the **first** TaskRouter call and forces `auto_loop=true` (so a single human prompt launches a full run).

---

## ‚ñ∂Ô∏è Example Workflow

### 0) Launch Router MCP
```bash
./orchestrator.sh
# Tails /docs/build-summary.md and /docs/router_log.jsonl
```

### 1) Kickoff (TaskRouter chat)
Paste this single message:
```
workflow_id: site-scaffold-001

Use /docs/site-spec.md as the source of truth. Execute the full build:
- Scaffold structure and files as specified
- Implement Home (hero, #disciplines, #contact, skip link, landmarks)
- Implement all three service pages with back-to-/#disciplines CTA
- Implement About and minimal JS
- Commit safely

Respond only with routing lines internally via router-mcp (auto_loop:true).
When complete, output:
DONE
<1‚Äì3 sentence final summary>
```

**Expected visible reply (TaskRouter):**  
`Kicked off workflow (id: site-scaffold-001). I‚Äôll summarize when done.`

### 2) Behind the scenes
- Router transforms each routing line into a guarded instruction:
  - Adds **SubAgent prefix**
  - Applies the correct **Rule title**
  - Requires the **rules-loaded** acknowledgment
- Router loops with TaskRouter until `DONE` (or max steps cap).

### 3) Logs & Final Output
- `/docs/build-summary.md` ‚Äî human timeline (steps + final block)  
- `/docs/router_log.jsonl` ‚Äî structured event log  
- `/docs/CHANGELOG.md` ‚Äî one entry per completed run  
- TaskRouter chat ends with:
```
DONE
<1‚Äì3 sentence final summary>
```

---

## üîê Security & Permissions
- **Least privilege** per profile:
  - `GitWorkflow`: git MCP only; no shell
  - `FileCreator`/`FrontendDeveloper`/`BackendDeveloper`: file writes OK; no shell
  - `TestRunner`: test MCP only; no edits
- **Stop conditions**:
  - TaskRouter emits `DONE`
  - Router enforces `ROUTER_MAX_STEPS`
- **Auditability**: All steps + final summaries persisted to `/docs/`
- **Isolation**: Keep code under `/project/`; specs in `/docs/site-spec.md`

---

## üß∞ Troubleshooting
- **Router not reachable** ‚Üí `curl http://localhost:8085/health` (check port/process/firewall)
- **No logs** ‚Üí ensure `/docs/` is writable; launcher scripts create files if missing
- **Profiles can‚Äôt call Router** ‚Üí ensure `router-mcp` is allowed for **TaskRouter**
- **Workflow stalls** ‚Üí open `/docs/router_log.jsonl` and look for `invalid_format` or `unknown_agent`
- **Ack issues** ‚Üí `ROUTER_ENFORCE_RULE_ACK=true` requires the exact first line:
  ```
  rules loaded (agent=<Role> | rule=<Rule Title>)
  ```

---

## üì¶ What goes where (recap)
- **Warp UI**  
  - *MCP Servers*: paste the **one-shot JSON** from `warp_config/warp-config.yaml`  
  - *Profiles*: mirror from `warp_config/warp-agent-config.yaml` (names, model, permissions, allowed servers)  
  - *Rules*: paste from `warp_config/prompts/*.md` (one Rule per profile)
- **Repo**  
  - `warp_config/warp-config.yaml` ‚Äî the JSON you pasted into Warp (kept here for team reference)  
  - `warp_config/warp-agent-config.yaml` ‚Äî authoritative profile spec (names, perms, allowed servers)  
  - `warp_config/prompts/*.md` ‚Äî Rule texts (role ‚Äúsystem prompts‚Äù)  
  - `router_mcp.py` ‚Äî orchestrator with auto-loop + logs  
  - `docs/*` ‚Äî logs + spec  
  - `project/src/*` ‚Äî generated code

### üì¶ Central MCP Servers Store

- `Important`: Some open-sourse repos such as test-mcp will have to be `cloned and run locally`, instead of using `npx`.
  - Keep them in a `single shared folder outside your project` so you don‚Äôt re-clone per repo.
  - For each MCP server, sometimes specific file paths will have to be referenced within the respective Warp MCP server config JSON 
> Having dedicated MCP folder prevents having to change the stored path(s) in that MCP server JSON config, when changing projects.
> > Note: The `working directory` value will still have to be changed when switching projects.


---

## ‚úÖ Summary
- **One prompt** launches a full, logged, policy-guarded build to `DONE`
- Warp keeps calling the LLM; Router orchestrates + logs
- Profiles are **least-privilege**; Rules are auto-applied & acknowledged
- All artifacts are auditable under `/docs/`

Happy building! üõ†Ô∏è‚ú®
